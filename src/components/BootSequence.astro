---
/**
 * BootSequence.astro
 * "Once Upon a Time..." intro sequence for the Winter Storybook baby shower game.
 * Plays once per session using sessionStorage.
 */

interface Props {
    storageKey?: string;
    mobile?: boolean;
}

const { storageKey = "storybookIntroPlayed", mobile = false } = Astro.props;
---

<div id="boot-sequence" class="boot-sequence" data-storage-key={storageKey}>
    <div class="boot-ascii" id="boot-ascii"></div>
    <div id="boot-lines"></div>
    <div class="boot-progress" id="boot-progress" style="display: none;">
        <div class="boot-progress__bar" style="width: 200px;">
            <div class="boot-progress__fill" id="boot-progress-fill"></div>
        </div>
        <span class="boot-progress__text" id="boot-progress-text">0%</span>
    </div>
</div>

<script>
    interface StoryLine {
        text: string;
        class?: string;
        delay: number;
    }

    const StorybookIntro = {
        // Winter-themed decorative header
        asciiArt: `
    *  .  *
       *    .    *
  .    *  BABY IT'S COLD OUTSIDE  *    .
       .    *    .
    *  .  *
        `,

        mobileAsciiArt: `
    *  .  *
  BABY IT'S COLD OUTSIDE
    *  .  *
        `,

        // Storybook-style intro lines for TV/Desktop
        storyLines: [
            {
                text: "Once upon a winter's night...",
                class: "boot-line--header",
                delay: 400,
            },
            { text: "The snowflakes danced outside the window...", delay: 300 },
            { text: "And inside, a warm glow filled the lodge...", delay: 300 },
            {
                text: "For a very special guest was on the way!",
                class: "boot-line--success",
                delay: 400,
            },
            { text: "A bundle of joy to warm every heart...", delay: 300 },
            {
                text: "Let the celebration begin!",
                class: "boot-line--header",
                delay: 400,
            },
        ] as StoryLine[],

        // Shorter version for mobile
        mobileStoryLines: [
            {
                text: "Once upon a winter's night...",
                class: "boot-line--header",
                delay: 300,
            },
            { text: "A special guest was on the way!", delay: 250 },
            {
                text: "Let the celebration begin!",
                class: "boot-line--success",
                delay: 300,
            },
        ] as StoryLine[],

        hasPlayed: false,

        async play(mobile: boolean = false): Promise<void> {
            const container = document.getElementById("boot-sequence");
            if (!container) return;

            const storageKey =
                container.dataset.storageKey || "storybookIntroPlayed";

            // Check if intro already played this session
            if (sessionStorage.getItem(storageKey)) {
                this.skip();
                return;
            }

            const asciiEl = document.getElementById("boot-ascii");
            const linesEl = document.getElementById("boot-lines");
            const progressEl = document.getElementById("boot-progress");
            const progressFill = document.getElementById("boot-progress-fill");
            const progressText = document.getElementById("boot-progress-text");

            if (
                !asciiEl ||
                !linesEl ||
                !progressEl ||
                !progressFill ||
                !progressText
            )
                return;

            // Set header art based on mobile/desktop
            asciiEl.textContent = mobile ? this.mobileAsciiArt : this.asciiArt;

            const lines = mobile ? this.mobileStoryLines : this.storyLines;

            // Display story lines one by one with gentle fade-in
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lineEl = document.createElement("div");
                lineEl.className = `boot-line ${line.class || ""}`;
                lineEl.textContent = line.text;
                linesEl.appendChild(lineEl);

                await this.sleep(line.delay);
                lineEl.classList.add("visible");
            }

            // Show progress bar with "turning pages" feel
            await this.sleep(400);
            progressEl.style.display = "flex";

            // Animate progress bar smoothly
            for (let i = 0; i <= 100; i += 2) {
                progressFill.style.width = `${i}%`;
                progressText.textContent = `${i}%`;
                await this.sleep(mobile ? 10 : 15);
            }

            // Gentle fade out
            await this.sleep(500);
            container.style.transition = "opacity 0.6s ease-out";
            container.style.opacity = "0";

            await this.sleep(600);
            container.classList.add("hidden");

            // Mark as played in sessionStorage
            sessionStorage.setItem(storageKey, "true");
            this.hasPlayed = true;
        },

        skip(): void {
            const container = document.getElementById("boot-sequence");
            if (container) {
                container.classList.add("hidden");
            }
            this.hasPlayed = true;
        },

        sleep(ms: number): Promise<void> {
            return new Promise((resolve) => setTimeout(resolve, ms));
        },
    };

    // Expose to window
    (window as any).BootSequence = StorybookIntro;
    (window as any).StorybookIntro = StorybookIntro;

    // Auto-play on DOM ready
    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("boot-sequence");
        const isMobile =
            container?.dataset.storageKey?.includes("mobile") ||
            window.innerWidth < 768;
        StorybookIntro.play(isMobile);
    });

    // Also handle Astro View Transitions - skip intro on navigation
    document.addEventListener("astro:page-load", () => {
        const container = document.getElementById("boot-sequence");
        if (container) {
            const storageKey =
                container.dataset.storageKey || "storybookIntroPlayed";
            if (sessionStorage.getItem(storageKey)) {
                StorybookIntro.skip();
            }
        }
    });
</script>
