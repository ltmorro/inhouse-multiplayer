{% extends "_layout.html" %}

{% block title %}MAIN DISPLAY{% endblock %}

{% block content %}
<!-- Boot Sequence Overlay -->
<div id="boot-sequence" class="boot-sequence">
    <div class="boot-ascii" id="boot-ascii"></div>
    <div id="boot-lines"></div>
    <div class="boot-progress" id="boot-progress" style="display: none;">
        <div class="boot-progress__bar">
            <div class="boot-progress__fill" id="boot-progress-fill"></div>
        </div>
        <span class="boot-progress__text" id="boot-progress-text">0%</span>
    </div>
</div>

<!-- VHS Transition Overlay -->
<div class="vhs-transition" id="vhs-transition"></div>
<div class="static-burst" id="static-burst"></div>
<div class="scanline-sweep" id="scanline-sweep"></div>

<!-- Timer Critical Overlay (red vignette) -->
<div class="timer-critical-overlay" id="timer-critical-overlay"></div>

<!-- Windows 98 Error Dialog -->
<div class="win98-overlay hidden" id="win98-overlay">
    <div class="win98-dialog">
        <div class="win98-titlebar">
            <div class="win98-titlebar__text">
                <span id="win98-title">Y2K Error</span>
            </div>
            <button class="win98-close" onclick="Win98Dialog.hide()">×</button>
        </div>
        <div class="win98-content">
            <div class="win98-icon" id="win98-icon">⚠️</div>
            <div class="win98-message" id="win98-message">
                <strong>An error has occurred.</strong>
                Something went wrong.
            </div>
        </div>
        <div class="win98-buttons">
            <button class="win98-btn" onclick="Win98Dialog.hide()">OK</button>
        </div>
    </div>
</div>

<!-- Blue Screen of Death -->
<div class="bsod-overlay hidden" id="bsod-overlay">
    <div class="bsod-content">
        <div class="bsod-header">Y2K PARTY GAME</div>
        <div class="bsod-text">
            A fatal exception 0E has occurred at 0028:C0011E36 in VXD VMM(01) +
            00010E36. The current application will be terminated.
        </div>
        <div class="bsod-team" id="bsod-team-name">TEAM NAME</div>
        <div class="bsod-text">
            * Your team has been ELIMINATED from the game.<br>
            * All unsaved progress has been lost.<br>
            * The Y2K bug has claimed another victim.
        </div>
        <div class="bsod-prompt">
            Press any key to continue_
        </div>
    </div>
</div>

<!-- TV Views Container -->

<!-- Game Progress Indicator -->
<div class="game-progress" id="game-progress">
    <div class="game-progress__round" id="progress-round">Round 1 of 7</div>
    <div class="game-progress__bar">
        <div class="game-progress__fill" id="progress-fill" style="width: 0%;"></div>
    </div>
</div>

<!-- Matrix Rain Canvas (screensaver for idle lobby) -->
<canvas id="matrix-rain" class="matrix-rain-canvas"></canvas>

<!-- Lobby View -->
<div id="view-lobby" class="view active">
    <div class="tv-layout">
        <div class="tv-header">
            <h1 class="tv-title glow-strong">EMERGENCY TERMINAL ONLINE</h1>
            <p class="tv-subtitle mt-2">Y2K COMPLIANCE CHECK IN PROGRESS...</p>
        </div>
        <div class="tv-content">
            <div class="text-center">
                <div id="qr-code" class="mt-3 hidden">
                    <canvas id="qr-canvas" style="border: 4px solid var(--terminal-green); background: white; width: 350px; height: 350px;"></canvas>
                    <p id="qr-url" class="tv-hint mt-2"></p>
                    <p class="tv-status">Scan to join</p>
                </div>

                <div class="mt-3">
                    <h3 class="tv-section-heading">CONNECTED TEAMS</h3>
                    <div id="lobby-teams" class="tv-status mt-2">
                        <!-- Team list injected here -->
                        <p class="tv-status">No teams connected</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="tv-footer">
            <div id="scoreboard-mini" class="text-center">
                <!-- Mini scoreboard -->
            </div>
        </div>
    </div>
</div>

<!-- MacGyver View -->
<div id="view-macgyver" class="view">
    <div class="tv-layout">
        <div class="tv-header">
            <h1 class="tv-title glow-strong">SUPPLY CHAIN COLLAPSE</h1>
            <p class="tv-subtitle">PROTOCOL 1 - MACGYVER</p>
        </div>
        <div class="tv-content">
            <div class="text-center">
                <p id="macgyver-message" class="tv-main-message glow-strong">YOUR SURVIVAL KIT HAS ARRIVED. ADAPT OR PERISH.</p>
            </div>
        </div>
        <div class="tv-instructions">
            <div class="tv-instructions-box">
                <p class="instruction-title">EMERGENCY SUPPLY PROTOCOL</p>
                <p class="instruction-text">The stores are empty. Supply routes have failed. <strong>Open a beverage using ONLY these salvaged materials!</strong> The host will judge your ingenuity.</p>
            </div>
        </div>
        <div class="tv-footer">
            <div id="macgyver-scoreboard"></div>
        </div>
    </div>
</div>

<!-- Trivia View -->
<div id="view-trivia" class="view">
    <div class="tv-layout">
        <div class="tv-header">
            <h1 class="tv-title glow-strong">ALL SEARCH ENGINES OFFLINE</h1>
            <p class="tv-subtitle">PROTOCOL 2 - GOOGLE IS DOWN</p>
        </div>
        <div class="tv-content">
            <div class="text-center" style="max-width: 85%;">
                <p id="trivia-question" class="tv-main-message glow-strong">
                    Waiting for question...
                </p>
                <div id="trivia-submission-status" class="tv-status mt-3">
                    <!-- "3/4 teams submitted" -->
                </div>
                <div id="trivia-answer-reveal" class="tv-label mt-3 hidden">
                    <!-- Revealed answer -->
                </div>
                <div id="trivia-team-answers" class="tv-table-container mt-3 hidden">
                    <!-- Team answers table injected here -->
                </div>
            </div>
        </div>
        <div class="tv-instructions" id="trivia-instructions">
            <div class="tv-instructions-box">
                <p class="instruction-title">THE INTERNET HAS COLLAPSED</p>
                <p class="instruction-text">No lifelines. No connections. Just what's left in your head. <strong>TRANSMIT your answer</strong> before timeout. Wrong answers cannot be un-sent.</p>
            </div>
        </div>
        <div class="tv-footer">
            <div id="trivia-scoreboard"></div>
        </div>
    </div>
</div>

<!-- Timer View -->
<div id="view-timer" class="view">
    <div class="tv-layout">
        <div class="tv-header">
            <h1 class="tv-title glow-strong">MIND CONTROL SIGNALS DETECTED</h1>
            <p class="tv-subtitle">PROTOCOL 3 - TIN FOIL HAT</p>
        </div>
        <div class="tv-content flex-column">
            <p id="timer-message" class="tv-timer-message">SHIELD YOURSELF BEFORE TIME EXPIRES</p>
            <div id="timer-display" class="tv-timer glow-strong mt-3">
                03:00
            </div>
            <div class="timer-progress tv-progress mt-3">
                <div id="timer-progress-bar" class="timer-progress__bar" style="width: 100%;"></div>
            </div>
        </div>
        <div class="tv-instructions">
            <div class="tv-instructions-box">
                <p class="instruction-title">GOVERNMENT FREQUENCIES AT CRITICAL LEVELS</p>
                <p class="instruction-text">The satellites are watching. <strong>Construct protective headgear IMMEDIATELY.</strong> Your thoughts are NOT secure. The host will judge effectiveness.</p>
            </div>
        </div>
        <div class="tv-footer">
            <div id="timer-scoreboard"></div>
        </div>
    </div>
</div>

<!-- Buzzer View -->
<div id="view-buzzer" class="view">
    <div class="tv-layout">
        <div class="tv-header">
            <h1 class="tv-title glow-strong">Y2K DATA CORRUPTION</h1>
            <p class="tv-subtitle">PROTOCOL 4 - CORRUPTED AUDIO</p>
        </div>
        <div class="tv-content">
            <div class="text-center">
                <!-- HTML5 Audio Player (controllable) -->
                <div id="audio-player-container" class="hidden mb-3">
                    <audio id="audio-player" style="display: none;"></audio>
                    <div id="audio-visualizer" class="tv-audio-visualizer">
                        <div class="audio-bar" style="animation: audioBar 0.5s ease-in-out infinite alternate;"></div>
                        <div class="audio-bar" style="animation: audioBar 0.7s ease-in-out infinite alternate;"></div>
                        <div class="audio-bar" style="animation: audioBar 0.4s ease-in-out infinite alternate;"></div>
                        <div class="audio-bar" style="animation: audioBar 0.6s ease-in-out infinite alternate;"></div>
                        <div class="audio-bar" style="animation: audioBar 0.5s ease-in-out infinite alternate;"></div>
                        <div class="audio-bar" style="animation: audioBar 0.8s ease-in-out infinite alternate;"></div>
                        <div class="audio-bar" style="animation: audioBar 0.45s ease-in-out infinite alternate;"></div>
                        <div class="audio-bar" style="animation: audioBar 0.55s ease-in-out infinite alternate;"></div>
                    </div>
                    <div id="audio-paused-indicator" class="tv-paused hidden">
                        [ PAUSED ]
                    </div>
                </div>

                <!-- Track reveal (hidden until revealed) -->
                <div id="audio-reveal" class="hidden mb-3">
                    <p class="tv-label">THE ANSWER:</p>
                    <p id="audio-track-title" class="tv-reveal glow-strong"></p>
                    <p id="audio-artist" class="tv-status"></p>
                </div>

                <p id="buzzer-hint" class="tv-main-message">
                    AUDIO DEGRADING... IDENTIFY BEFORE DATA LOSS
                </p>
                <div id="buzzer-locked-display" class="mt-3 hidden">
                    <p class="tv-label">LOCKED BY:</p>
                    <p id="buzzer-locked-team" class="tv-reveal glow-strong"></p>
                </div>
                <div id="buzzer-ready-display" class="mt-3">
                    <p class="tv-active-indicator glow blink">BUZZER ACTIVE</p>
                </div>
            </div>
        </div>
        <div class="tv-instructions" id="buzzer-instructions">
            <div class="tv-instructions-box">
                <p class="instruction-title">PARTIAL SIGNAL RECOVERED</p>
                <p class="instruction-text">The Y2K bug has corrupted our audio archives. <strong>Identify the transmission before data degrades!</strong> First responder locks in. Wrong answer = signal lost.</p>
            </div>
        </div>
        <div class="tv-footer">
            <div id="buzzer-scoreboard"></div>
        </div>
    </div>
</div>

<!-- Timeline View -->
<div id="view-timeline" class="view">
    <div class="tv-layout">
        <div class="tv-header">
            <h1 class="tv-title glow-strong">TEMPORAL DATABASE CORRUPTED</h1>
            <p class="tv-subtitle">PROTOCOL 5 - TIMELINE RESTORATION</p>
        </div>
        <div class="tv-content">
            <div class="text-center">
                <!-- Waiting state (shown when no timeline data) -->
                <div id="timeline-waiting-tv" class="tv-waiting">
                    <p class="tv-waiting">Awaiting temporal anomaly data...</p>
                    <p class="tv-cursor blink mt-2">_</p>
                </div>

                <!-- Active timeline content (hidden when waiting) -->
                <div id="timeline-active-tv" class="hidden">
                    <!-- Display the scrambled timeline items -->
                    <div id="timeline-items-tv" class="tv-table-container mt-2" style="text-align: left;">
                        <p class="tv-section-heading text-center mb-2">SCRAMBLED EVENTS:</p>
                        <ul id="timeline-items-list-tv" class="tv-list">
                            <!-- Timeline items injected here -->
                        </ul>
                    </div>
                    <div id="timeline-team-status" class="tv-status mt-3">
                        <!-- Team progress indicators -->
                    </div>
                    <div id="timeline-winner" class="mt-3 hidden">
                        <p class="tv-label">WINNER:</p>
                        <p id="timeline-winner-name" class="tv-reveal glow-strong"></p>
                    </div>
                    <div id="timeline-team-submissions" class="tv-table-container mt-3 hidden">
                        <!-- Team submissions table injected here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="tv-instructions">
            <div class="tv-instructions-box">
                <p class="instruction-title">HISTORICAL RECORDS SCRAMBLED BY Y2K BUG</p>
                <p class="instruction-text">Reality itself is at stake. <strong>Restore the timeline before it collapses!</strong> Drag events into chronological order. First correct restoration = maximum points.</p>
            </div>
        </div>
        <div class="tv-footer">
            <div id="timeline-scoreboard"></div>
        </div>
    </div>
</div>

<!-- Picture Guess View -->
<div id="view-pictureguess" class="view">
    <div class="tv-layout">
        <div class="tv-header">
            <h1 class="tv-title glow-strong">VISUAL ARCHIVES CORRUPTED</h1>
            <p class="tv-subtitle">PROTOCOL 7 - Y2K IMAGE RECOVERY</p>
        </div>
        <div class="tv-content">
            <div class="text-center" style="max-width: 90%;">
                <!-- Picture display container -->
                <div id="pictureguess-image-container" class="tv-image-container">
                    <img id="pictureguess-image" src="" alt="Mystery Picture" style="display: none;">
                    <p id="pictureguess-no-image" class="tv-waiting">Awaiting image transmission...</p>
                </div>

                <!-- Hint display -->
                <p id="pictureguess-hint-tv" class="tv-hint mt-2">
                    <!-- Hint text injected here -->
                </p>

                <div id="pictureguess-submission-status" class="tv-status mt-2">
                    <!-- "3/4 teams submitted" -->
                </div>

                <!-- Answer reveal -->
                <div id="pictureguess-answer-reveal" class="mt-3 hidden">
                    <p class="tv-label">THE ANSWER:</p>
                    <p id="pictureguess-correct-answer" class="tv-reveal glow-strong"></p>
                </div>

                <!-- Team guesses table -->
                <div id="pictureguess-team-guesses" class="tv-table-container mt-3 hidden">
                    <!-- Team guesses table injected here -->
                </div>
            </div>
        </div>
        <div class="tv-instructions" id="pictureguess-instructions">
            <div class="tv-instructions-box">
                <p class="instruction-title">Y2K IMAGE DATABASE FRAGMENTED</p>
                <p class="instruction-text">The millennium bug has scrambled our visual archives. <strong>IDENTIFY this artifact!</strong> Submit your analysis before the data degrades completely.</p>
            </div>
        </div>
        <div class="tv-footer">
            <div id="pictureguess-scoreboard"></div>
        </div>
    </div>
</div>

<!-- Minesweeper View -->
<div id="view-minesweeper" class="view">
    <div class="tv-layout">
        <div class="tv-header">
            <h1 class="tv-title glow-strong">NUCLEAR SILO COMPROMISED</h1>
            <p class="tv-subtitle">PROTOCOL 6 - MINESWEEPER ELIMINATION</p>
        </div>
        <div class="tv-content">
            <div class="text-center">
                <div class="tv-table-container">
                    <table class="scoreboard">
                        <thead>
                            <tr>
                                <th>TEAM</th>
                                <th>STATUS</th>
                                <th>SCORE</th>
                            </tr>
                        </thead>
                        <tbody id="minesweeper-teams">
                            <!-- Team rows injected here -->
                        </tbody>
                    </table>
                </div>
                <p id="minesweeper-remaining" class="tv-status mt-3">
                    <!-- "3 teams remaining" -->
                </p>
            </div>
        </div>
        <div class="tv-instructions">
            <div class="tv-instructions-box">
                <p class="instruction-title">Y2K HAS TRIGGERED FALSE LAUNCH CODES</p>
                <p class="instruction-text">Navigate the grid. <strong>One wrong tile = COMPLETE SYSTEM FAILURE.</strong> Safe sectors award points. Last surviving team restores manual control!</p>
            </div>
        </div>
        <div class="tv-footer"></div>
    </div>
</div>

<!-- Victory View -->
<div id="view-victory" class="view">
    <div class="tv-layout">
        <div class="tv-header">
            <h1 class="tv-title glow-strong">Y2K CRISIS AVERTED</h1>
            <p class="tv-subtitle">CIVILIZATION HAS BEEN SAVED</p>
        </div>
        <div class="tv-content">
            <div class="text-center">
                <p class="tv-label">HUMANITY'S SAVIORS</p>
                <p id="victory-winner" class="tv-reveal glow-strong"></p>
                <div class="tv-table-container mt-3">
                    <table class="scoreboard">
                        <thead>
                            <tr>
                                <th>RANK</th>
                                <th>TEAM</th>
                                <th>SCORE</th>
                            </tr>
                        </thead>
                        <tbody id="final-scoreboard">
                            <!-- Final scores injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="tv-footer">
            <p class="tv-footer-message text-center">The clocks have rolled over. Welcome to the year 2000. The future is now.</p>
        </div>
    </div>
</div>

<!-- Mock Mode Banner -->
<div id="mock-mode-banner" class="mock-mode-banner hidden">
    MOCK MODE - NO SERVER CONNECTION
</div>

<!-- News Ticker - Scrolling Y2K Headlines -->
<div class="news-ticker" id="news-ticker">
    <div class="news-ticker__track">
        <!-- Headlines populated by NewsTickerManager.init() -->
    </div>
</div>

<!-- Top Header Bar - Centered Countdown and Status -->
<div class="top-header-bar" id="top-header-bar">
    <div class="top-header-bar__content">
        <div class="top-header-bar__status">
            <span class="status-light status-light--ok" id="status-mainframe" title="MAINFRAME"></span>
            <span class="status-light status-light--ok" id="status-network" title="NETWORK"></span>
            <span class="status-light status-light--ok" id="status-database" title="DATABASE"></span>
            <span class="status-light status-light--warning" id="status-shield" title="Y2K SHIELD"></span>
        </div>
        <div class="top-header-bar__countdown">
            <span class="top-header-bar__label">Y2K</span>
            <span class="top-header-bar__time" id="midnight-time">00:00:00</span>
        </div>
        <div class="top-header-bar__teams-count">
            <span class="top-header-bar__teams-label">TEAMS</span>
            <span class="top-header-bar__teams-value" id="status-team-count">0</span>
        </div>
    </div>
</div>


<!-- Reaction Feed - Floating Emoji Reactions -->
<div class="reaction-feed" id="reaction-feed">
    <!-- Floating reactions populated by ReactionFeed -->
</div>

<!-- Chat Feed - Messages from Players -->
<div class="chat-feed" id="chat-feed">
    <!-- Chat messages populated by ChatFeed -->
</div>

<!-- Now Playing Indicator -->
<div class="now-playing hidden" id="now-playing">
    <div class="now-playing__icon">
        <span class="now-playing__bar"></span>
        <span class="now-playing__bar"></span>
        <span class="now-playing__bar"></span>
    </div>
    <div class="now-playing__info">
        <div class="now-playing__title" id="now-playing-title">---</div>
        <div class="now-playing__artist" id="now-playing-artist">---</div>
    </div>
</div>

<!-- Hidden countdown div for backwards compatibility -->
<div class="midnight-countdown hidden" id="midnight-countdown"></div>

<!-- Audio Unlock Overlay - must be clicked to enable Spotify playback -->
<div id="audio-unlock-overlay" class="audio-unlock-overlay">
    <div class="audio-unlock-content">
        <p class="tv-main-message mb-2">CLICK TO ENABLE AUDIO</p>
        <p class="tv-status">Browser requires user interaction before playing audio</p>
        <button id="audio-unlock-btn" class="terminal-btn tv-label mt-3">
            ENABLE AUDIO
        </button>
    </div>
</div>

<style>
/* Game Progress Indicator */
.game-progress {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0) 100%);
    padding: 12px 20px 20px;
    display: none;
}
.game-progress.visible {
    display: block;
}
.game-progress__round {
    color: var(--terminal-green);
    font-family: 'VT323', monospace;
    font-size: 1.2rem;
    text-align: center;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 0 5px var(--terminal-green-glow);
}
.game-progress__bar {
    height: 6px;
    background: rgba(0, 255, 0, 0.15);
    border: 1px solid var(--terminal-green-dim);
    border-radius: 0;
    overflow: hidden;
    position: relative;
}
.game-progress__fill {
    height: 100%;
    background: var(--terminal-green);
    box-shadow: 0 0 10px var(--terminal-green), 0 0 20px var(--terminal-green-glow);
    transition: width 0.5s ease-out;
    position: relative;
}
.game-progress__fill::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 20px;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3));
}

/* Matrix Rain Screensaver */
.matrix-rain-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 5;
    pointer-events: none;
    opacity: 0;
    transition: opacity 2s ease-in-out;
}
.matrix-rain-canvas.active {
    opacity: 1;
}

.audio-unlock-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    cursor: pointer;
}
.audio-unlock-overlay.hidden {
    display: none;
}
.audio-unlock-content {
    text-align: center;
    color: var(--terminal-green);
}
</style>
{% endblock %}

{% block scripts %}
<!-- QR Code Generator (browser-compatible) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<!-- Spotify Web Playback SDK - callback must be defined BEFORE loading the SDK -->
<script>
    // This callback is called by the Spotify SDK when it's ready
    // It must be defined BEFORE loading the SDK script
    window.onSpotifyWebPlaybackSDKReady = () => {
        console.log('[Spotify] SDK ready callback fired');
        // SpotifyPlayer.connectPlayer() will be called from tv.js init
        // We just set a flag here so tv.js knows the SDK is ready
        window.spotifySDKReady = true;
    };
</script>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script src="{{ url_for('static', filename='js/tv.js') }}"></script>
{% endblock %}
